

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒ›ãƒ¼ãƒ </title>
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/1/19/Google_Classroom_Logo.svg">
<link rel="preconnect" href="https://teaching-materials-r4zf.onrender.com">
<link rel="dns-prefetch" href="https://teaching-materials-r4zf.onrender.com">

<style>
  /* --- æ—¢å­˜ã®CSSã¯ã“ã“ã«ãã®ã¾ã¾ --- */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:#fff;color:#111}
  a{color:inherit;text-decoration:none}
  img{max-width:100%;display:block}
  header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;padding:8px 16px;gap:12px;height:64px}
  .logo{display:flex;align-items:center;gap:8px;cursor:pointer}
  .logo .icon{width:36px;height:36px;border-radius:6px;background:#ff0000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  .search{flex:1;display:flex;justify-content:center}
  .search input{width:100%;max-width:720px;padding:10px 14px;border-radius:20px;border:1px solid #ddd;outline:none}
  .actions{display:flex;gap:12px;align-items:center}
  main{display:flex;gap:20px;padding:16px;align-items:flex-start}
  .content{flex:1}
  .video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .card{cursor:pointer}
  .thumb{position:relative;border-radius:6px;overflow:hidden;background:#eee}
  .thumb img{width:100%;height:auto;display:block}
  .meta{display:flex;gap:12px;margin-top:8px}
  .channel-thumb{width:36px;height:36px;border-radius:50%;flex:0 0 36px;background:#ddd;overflow:hidden}
  .meta .info{flex:1}
  .meta .info .title{font-weight:600;line-height:1.2;margin-bottom:6px}
  .meta .info .sub{color:#606060;font-size:13px}
  .watch-container{display:flex;gap:20px}
  .main-col{flex:0 0 60%}
  .side-col{flex:0 0 40%}
  .player-box{background:#000;aspect-ratio:16/9;border-radius:6px;overflow:hidden}
  .player-meta{margin-top:12px}
  .player-meta h1{font-size:18px;margin:0 0 8px 0}
  .stats{color:#606060;font-size:13px;margin-bottom:12px;display:flex;gap:12px;flex-wrap:wrap}
  .channel-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-top:1px solid #eee;border-bottom:1px solid #eee;margin-top:12px}
  .channel-row img{width:48px;height:48px;border-radius:50%;overflow:hidden}
  .channel-row .ch-info{flex:1}
  .btn-sub{background:#cc0000;color:#fff;padding:8px 12px;border-radius:16px;font-weight:700;cursor:pointer}
  .comments{margin-top:12px}
  .comment{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid #f0f0f0}
  .comment img{width:36px;height:36px;border-radius:50%}
  .comment .c-body{flex:1}
  .comment .c-body .name{font-weight:700;font-size:13px}
  .comment .c-body .text{color:#333;margin-top:6px}
  .related-item{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid #f5f5f5;cursor:pointer}
  .related-thumb{width:168px;flex:0 0 168px;overflow:hidden;border-radius:6px}
  .related-info{flex:1}
  .related-info .title{font-size:14px;font-weight:600}
  @media(max-width:900px){
    main{padding:12px}
    .watch-container{flex-direction:column}
    .main-col,.side-col{flex:1 1 100%}
    .related-thumb{width:120px;flex:0 0 120px}
    .search input{max-width:420px}
  }
.watch-container { display: flex; gap: 20px; height: calc(100vh - 64px - 32px); }
.main-col { flex: 0 0 60%; display: flex; flex-direction: column; overflow-y: auto; padding-right: 4px; }
.side-col { flex: 0 0 40%; display: flex; flex-direction: column; overflow-y: auto; padding-left: 4px; }
.player-box { flex: 0 0 auto; }
.comments { flex: 1 1 auto; overflow-y: auto; }
</style>
</head>
<body>

    <header>
      <div class="logo" id="homeBtn" title="Home">
        <div class="icon">Y</div>
        <div style="font-weight:700">YouTube</div>
      </div>
      <div class="search">
        <input id="searchInput" placeholder="æ¤œç´¢" autocomplete="off" />
      </div>
      <div class="actions">
        <div title="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ" style="width:36px;height:36px;border-radius:50%;background:#eee"></div>
      </div>
    </header>
    <main>
      <div class="content" id="app"></div>
    </main>
    <script>
      /* ã“ã“ã«å…ƒã®JavaScriptã‚³ãƒ¼ãƒ‰å…¨éƒ¨ã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹ */
/*
  YouTubeé¢¨ã‚·ãƒ³ã‚°ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¢ï¼ˆè¤‡æ•°APIã‚­ãƒ¼å¯¾å¿œï¼‰
  ä½¿ã„æ–¹:
    1) ä¸‹ã® API_KEYS ã‚’è‡ªåˆ†ã®ã‚­ãƒ¼ã«ç½®ãæ›ãˆï¼ˆå°‘ãªãã¨ã‚‚1ã¤å…¥ã‚Œã‚‹ï¼‰
    2) ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ãå ´åˆã¯å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ï¼ˆä¾‹: python -m http.serverï¼‰ã§èµ·å‹•
    3) å‹•ä½œ: ãƒ›ãƒ¼ãƒ ï¼ˆpopularï¼‰ / æ¤œç´¢ / å‹•ç”»å†ç”Ÿï¼ˆ#watch=VIDEOIDï¼‰ / ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆ#channel=CHANNELIDï¼‰
*/

/// --- å¤‰æ›´: è¤‡æ•°APIã‚­ãƒ¼å¯¾å¿œ ---
const API_KEYS = [
  'AIzaSyCHjVL925rnYBluF3MoHGdT0In1YH0F55s',
  'AIzaSyCN8NAC6kTbjfZvtGzPzLNnfwRMyeNIYdE',
  'AIzaSyC2kT3DmcKFuXJTddbUEQxFwUFPfxqW_iQ',
  'AIzaSyCogj_NUn2zVM3J64JTnwp0Aoe50NtQf0I',
  'AIzaSyBC-EmMsqeZkws0Sna5YVF3gjS_5Zj_g1w'
];

let keyIndex = 0;
/// --- /å¤‰æ›´ ---

const MAX_RESULTS = 12;

const el = id => document.getElementById(id);
const app = el('app');
const searchInput = el('searchInput');
const homeBtn = el('homeBtn');

let channelThumbCache = {};
let nextPageTokenHome = null;
let homeLoading = false;
let homeQuery = null;
let observerMap = new Map();

function fmtNum(n){
  if(n==null) return '';
  n = Number(n);
  if(n>=1e9) return (n/1e9).toFixed(1)+'B';
  if(n>=1e6) return (n/1e6).toFixed(1)+'M';
  if(n>=1e3) return (n/1e3).toFixed(1)+'K';
  return String(n);
}
function timeAgo(iso){
  const d = new Date(iso);
  const s = Math.floor((Date.now()-d.getTime())/1000);
  if(s<60) return s + 'ç§’å‰';
  if(s<3600) return Math.floor(s/60)+'åˆ†å‰';
  if(s<86400) return Math.floor(s/3600)+'æ™‚é–“å‰';
  if(s<2592000) return Math.floor(s/86400)+'æ—¥å‰';
  if(s<31536000) return Math.floor(s/2592000)+'ãƒ¶æœˆå‰';
  return Math.floor(s/31536000)+'å¹´ä»¥ä¸Šå‰';
}

// --- API ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
/*
  apiGet ã¯è¤‡æ•°ã‚­ãƒ¼ã‚’é †æ¬¡ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã€‚
  - ã‚¯ã‚©ãƒ¼ã‚¿è¶…éï¼ˆquotaExceededï¼‰ã‚„ 403 ãŒç™ºç”Ÿã—ãŸã‚‰æ¬¡ã®ã‚­ãƒ¼ã¸è‡ªå‹•ã§åˆ‡æ›¿ãˆãƒªãƒˆãƒ©ã‚¤ã™ã‚‹
  - ã™ã¹ã¦ã®ã‚­ãƒ¼ã§å¤±æ•—ã—ãŸã‚‰æœ€çµ‚ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
*/
async function apiGet(path, params = {}){
  if(!Array.isArray(API_KEYS) || API_KEYS.length === 0){
    throw new Error('API keys not configured');
  }

  // è©¦è¡Œã¯ã‚­ãƒ¼æ•°ã¾ã§
  const attempts = API_KEYS.length;
  let lastError = null;

  for(let i=0;i<attempts;i++){
    const key = API_KEYS[keyIndex % API_KEYS.length];
    // æ¬¡å›ã¯åˆ¥ã‚­ãƒ¼ã‚’ä½¿ã†ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ï¼‰
    keyIndex = (keyIndex + 1) % API_KEYS.length;

    try{
      params.key = key;
      const url = new URL('https://www.googleapis.com/youtube/v3/' + path);
      Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
      const resp = await fetch(url);
      const text = await resp.text();
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸­èº«ã‚’JSONã§parseã§ãã‚Œã°parseã™ã‚‹
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }
      if(resp.ok){
        return json;
      } else {
        // éOK: ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’èª¿ã¹ã¦ã€quotaExceededãªã‚‰æ¬¡ã®ã‚­ãƒ¼ã¸
        const reason = json?.error?.errors?.[0]?.reason || '';
        if(resp.status === 403 && reason === 'quotaExceeded'){
          console.warn('quotaExceeded on key, trying next key', {key});
          lastError = new Error('quotaExceeded on one key, trying next');
          // ç¶šè¡Œã—ã¦æ¬¡ã®ã‚­ãƒ¼ã§è©¦ã™
          continue;
        } else {
          // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ãã®ã¾ã¾æŠ•ã’ã‚‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚„ã™ãã™ã‚‹ï¼‰
          const msg = json?.error?.message || (`HTTP ${resp.status} ${text}`);
          throw new Error('API error: ' + msg);
        }
      }
    }catch(e){
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ä¸Šã§æŠ•ã’ãŸã‚¨ãƒ©ãƒ¼
      lastError = e;
      // ã‚‚ã—ã‚¨ãŒ quota ç”±æ¥ã§ã‚ã‚Œã°ã‚­ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ç¶šè¡Œã€ãã†ã§ãªã‘ã‚Œã°å†æŠ•ã’
      const isQuota = /quotaExceeded|quota/i.test(String(e.message));
      if(isQuota){
        console.warn('Detected quota issue, rotating key', {err:e.message});
        continue;
      } else {
        // ä¸€éƒ¨ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚­ãƒ¼åˆ‡æ›¿ã§æ”¹å–„ã™ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã€æ¬¡ã®ã‚­ãƒ¼ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
        // ãŸã ã—æ˜ç¢ºãªèªè¨¼ã‚¨ãƒ©ãƒ¼ãªã©ã¯ã™ãã«æŠ•ã’ã‚‹
        if(e.message && (e.message.includes('403') || e.message.includes('quota'))) {
          continue;
        }
        throw e;
      }
    }
  }

  // ã“ã“ã«åˆ°é”ã—ãŸã‚‰å…¨ã‚­ãƒ¼ã§å¤±æ•—
  throw new Error('All API keys exhausted or quota reached. Last error: ' + (lastError?.message || 'unknown'));
}

// --- ãƒãƒ£ãƒ³ãƒãƒ« ã‚µãƒ ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ ---
async function getChannelThumb(channelId){
  if(channelThumbCache[channelId]) return channelThumbCache[channelId];
  try{
    const res = await apiGet('channels', {part:'snippet,statistics',id:channelId});
    const thumb = res.items?.[0]?.snippet?.thumbnails?.default?.url || '';
    channelThumbCache[channelId] = thumb;
    return thumb;
  }catch(e){
    console.warn('channel thumb failed', e);
    return '';
  }
}

// --- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ---
window.addEventListener('hashchange', renderByHash);
homeBtn.addEventListener('click', () => { location.hash = ''; });

searchInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){ performSearch(searchInput.value.trim()); }
});

// åˆæœŸè¡¨ç¤º
renderByHash();

function renderByHash(){
  const h = location.hash.slice(1);
  if(!h) { renderHome(); return; }
  const [k,v] = h.split('=');
  if(k==='watch') return renderWatch(v);
  if(k==='channel') return renderChannel(v);
  if(k==='search') {
    searchInput.value = decodeURIComponent(v||'');
    performSearch(decodeURIComponent(v||''));
    return;
  }
  renderHome();
}

/* -------------------- ãƒ›ãƒ¼ãƒ ï¼ˆäººæ°—/ãŠã™ã™ã‚ï¼‰ -------------------- */
function renderHome(){
  app.innerHTML = `
    <section id="homeSection">
      <div style="margin:12px 0;font-weight:700;font-size:18px">ãŠã™ã™ã‚</div>
      <div class="video-grid" id="videoGrid"></div>
      <div id="homeSentinel" style="height:32px"></div>
    </section>
  `;
  nextPageTokenHome = null;
  homeQuery = null;
  setupHomeInfinite();
  loadHome();
}

async function loadHome(){
  if(homeLoading) return;
  homeLoading = true;
  const grid = el('videoGrid');
  try{
    const params = {
      part:'snippet,statistics,contentDetails',
      chart:'mostPopular',
      maxResults: MAX_RESULTS,
      regionCode: 'JP'
    };
    if(nextPageTokenHome) params.pageToken = nextPageTokenHome;
    const res = await apiGet('videos', params);
    nextPageTokenHome = res.nextPageToken || null;
    for(const item of res.items || []){
      const card = await makeVideoCard(item);
      grid.appendChild(card);
    }
  }catch(e){
    console.error(e);
    grid.innerHTML += `<div style="color:#c00">èª­ã¿è¾¼ã¿å¤±æ•—: ${escapeHtml(e.message || String(e))}</div>`;
  } finally {
    homeLoading = false;
  }
}

async function makeVideoCard(item){
  // item: videos.list ã®çµæœ (snippet,statistics,contentDetails)
  const vid = item.id;
  const sn = item.snippet || {};
  const th = sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || '';
  const title = sn.title || '';
  const chId = sn.channelId;
  const chTitle = sn.channelTitle || '';
  const views = item.statistics?.viewCount || '';
  const publishedAt = sn.publishedAt || '';
  const channelThumb = await getChannelThumb(chId);

  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <div class="thumb" data-vid="${vid}">
      <img src="${th}" alt="">
    </div>
    <div class="meta">
      <div class="channel-thumb"><img src="${channelThumb}" alt=""></div>
      <div class="info">
        <div class="title">${escapeHtml(title)}</div>
        <div class="sub">
          <a href="#channel=${chId}" data-channel="${chId}" class="ch-link">${escapeHtml(chTitle)}</a>
          ãƒ» ${fmtNum(views)} å›è¦–è´ ãƒ» ${timeAgo(publishedAt)}
        </div>
      </div>
    </div>
  `;
  div.querySelector('.thumb').addEventListener('click', () => {
    location.hash = `watch=${vid}`;
  });
  div.querySelector('.ch-link').addEventListener('click', (e) => {
    // ãƒªãƒ³ã‚¯é·ç§»ã¯ hashchange ã§å‡¦ç†
    e.preventDefault();
    e.stopPropagation();
    location.hash = `channel=${chId}`;
  });
  return div;
}

function setupHomeInfinite(){
  const sentinel = el('homeSentinel');
  if(!sentinel) return;
  const io = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting) loadHome();
    });
  }, {rootMargin:'400px'});
  io.observe(sentinel);
  observerMap.set('home', io);
}

/* -------------------- æ¤œç´¢æ©Ÿèƒ½ -------------------- */
async function performSearch(q){
  if(!q) return renderHome();
  location.hash = `search=${encodeURIComponent(q)}`;
  app.innerHTML = `
    <section>
      <div style="margin:12px 0;font-weight:700;font-size:18px">æ¤œç´¢çµæœ: ${escapeHtml(q)}</div>
      <div class="video-grid" id="videoGrid"></div>
      <div id="searchSentinel" style="height:32px"></div>
    </section>
  `;
  const grid = el('videoGrid');
  let nextPage = null;
  let loading = false;

  const loadMore = async () => {
    if(loading) return;
    loading = true;
    try{
      const params = {part:'snippet',q:q,type:'video',maxResults:MAX_RESULTS};
      if(nextPage) params.pageToken = nextPage;
      const res = await apiGet('search', params);
      nextPage = res.nextPageToken || null;
      const ids = (res.items||[]).map(it => it.id.videoId).filter(Boolean);
      if(ids.length){
        const vs = await apiGet('videos', {part:'snippet,statistics,contentDetails',id:ids.join(',')});
        for(const v of vs.items||[]) {
          const card = await makeVideoCard(v);
          grid.appendChild(card);
        }
      }
    }catch(e){
      console.error('search error',e);
      grid.innerHTML += `<div style="color:#c00">èª­ã¿è¾¼ã¿å¤±æ•—: ${escapeHtml(e.message || String(e))}</div>`;
    } finally {
      loading = false;
    }
  };

  // IntersectionObserver ã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const sentinel = el('searchSentinel');
  const io = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting) loadMore();
    });
  }, {rootMargin:'400px'});
  io.observe(sentinel);
  observerMap.set('search', io);
  loadMore();
}

/* -------------------- å‹•ç”»å†ç”Ÿç”»é¢ -------------------- */
async function renderWatch(videoId){
  // æ—¢å­˜ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã¯åœæ­¢
  observerMap.forEach((o)=>o.disconnect());
  observerMap.clear();

  app.innerHTML = `<div>èª­ã¿è¾¼ã¿ä¸­...</div>`;
  try{
    // å‹•ç”»è©³ç´°
    const vd = await apiGet('videos', {part:'snippet,statistics,contentDetails',id:videoId});
    const item = vd.items?.[0];
    if(!item) throw new Error('å‹•ç”»ãŒè¦‹ã¤ã‹ã‚‰ãªã„');
    const sn = item.snippet;
    const stats = item.statistics || {};
    const chId = sn.channelId;

    // ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±
    const ch = await apiGet('channels', {part:'snippet,statistics',id:chId});
    const chItem = ch.items?.[0] || {};
    const chThumb = chItem.snippet?.thumbnails?.default?.url || '';

    // ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæœ€åˆã®ãƒšãƒ¼ã‚¸ï¼‰
    // é–¢é€£å‹•ç”» (search.list relatedToVideoId)
    app.innerHTML = `
      <div class="watch-container">
        <div class="main-col">
          <div class="player-box">
            <iframe id="videoIframe" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width:100%;height:100%;"></iframe>
          </div>
          <div class="player-meta">
            <h1>${escapeHtml(sn.title)}</h1>
  <div class="stats">
  <div>${fmtNum(stats.viewCount)} å›è¦–è´</div>
  <div>ãƒ»</div>
  <div>${timeAgo(sn.publishedAt)}</div>

  <div style="margin-left:auto;font-weight:700">
    ${fmtNum(stats.likeCount || 0)} ğŸ‘
  </div>

  <!-- â˜…â˜… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆé«˜è©•ä¾¡ã®å³å´ï¼‰â˜…â˜… -->
  <select id="playerSelect" style="margin-left:8px">
    <option value="official" selected>å…¬å¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</option>
    <option value="original">ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</option>
  </select>
</div>


            <div class="channel-row">
              <img src="${chThumb}" alt="">
              <div class="ch-info">
                <div style="font-weight:700">
                <a href="#channel=${chId}" class="watch-ch-link" style="text-decoration:none;color:inherit">
                   ${escapeHtml(chItem.snippet?.title || sn.channelTitle)}
                </a>
                 </div>

                <div style="color:#606060;font-size:13px">${fmtNum(chItem.statistics?.subscriberCount)} äººã®ç™»éŒ²è€…</div>
              </div>
              <div class="btn-sub">ç™»éŒ²</div>
            </div>

            <div style="margin-top:12px;color:#333">${escapeHtml(sn.description || '').slice(0,600)}${(sn.description||'').length>600 ? 'â€¦' : ''}</div>

            <div class="comments" id="commentsArea">
              <h3 style="margin-top:12px">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
              <div id="commentsList"></div>
              <div id="commentsSentinel" style="height:32px"></div>
            </div>
          </div>
        </div>

        <aside class="side-col">
          <div style="font-weight:700;margin-bottom:8px">æ¬¡ã«å†ç”Ÿ</div>
          <div id="relatedList"></div>
        </aside>
      </div>
    `;

    // --- è¿½åŠ : ãƒãƒ£ãƒ³ãƒãƒ«ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç† ---
    const watchChLink = app.querySelector('.watch-ch-link');
    if(watchChLink){
      watchChLink.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        location.hash = `channel=${chId}`;
      });
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿
    setupComments(videoId);

    // é–¢é€£å‹•ç”»èª­ã¿è¾¼ã¿
    loadRelated(videoId);

const playerSelect = document.getElementById('playerSelect');
const iframe = document.getElementById('videoIframe');

playerSelect.addEventListener('change', () => {
  if(playerSelect.value === 'official'){
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
  } else {
    iframe.src = `/watch.html?id=${videoId}`;
  }
});

  }catch(e){
    app.innerHTML = `<div style="color:#c00">èª­ã¿è¾¼ã¿å¤±æ•—: ${escapeHtml(e.message || String(e))}</div>`;
  }
}

async function loadRelated(videoId){
  const container = document.getElementById('relatedList');
  container.innerHTML = '<div>èª­ã¿è¾¼ã¿ä¸­â€¦</div>';

  let relatedItems = [];
  try {
    // ã¾ãš relatedToVideoId ã‚’è©¦ã™
    const res = await apiGet('search', {
      part: 'snippet',
      relatedToVideoId: videoId,
      type: 'video',
      maxResults: 12
    });
    relatedItems = res.items || [];
  } catch (e) {
    console.warn('relatedToVideoId failed, fallback search by title', e);

    // å¤±æ•—ã—ãŸã‚‰ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢ã§ä»£æ›¿
    try {
      // å‹•ç”»ã®è©³ç´°ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ã†
      const vd = await apiGet('videos', { part: 'snippet', id: videoId });
      const item = vd.items?.[0];
      const titleQuery = item?.snippet?.title || '';

      if(titleQuery){
        const searchRes = await apiGet('search', {
          part: 'snippet',
          q: titleQuery,
          type: 'video',
          maxResults: 12
        });
        relatedItems = searchRes.items || [];
      }
    } catch (fallbackErr) {
      console.error('fallback search failed', fallbackErr);
    }
  }

  // çµæœã‚’è¡¨ç¤º
  if(relatedItems.length){
    container.innerHTML = '';
    const ids = relatedItems.map(it => it.id.videoId).filter(Boolean);
    if(ids.length){
      const vs = await apiGet('videos', { part: 'snippet,statistics,contentDetails', id: ids.join(',') });
      for(const v of vs.items || []){
        const div = document.createElement('div');
        div.className = 'related-item';
        div.innerHTML = `
          <div class="related-thumb"><img src="${v.snippet.thumbnails?.medium?.url||''}" alt=""></div>
          <div class="related-info">
            <div class="title">${escapeHtml(v.snippet.title)}</div>
            <div style="color:#606060;font-size:13px">${escapeHtml(v.snippet.channelTitle)} ãƒ» ${fmtNum(v.statistics?.viewCount)} å›</div>
          </div>
        `;
        div.addEventListener('click', ()=> location.hash = `watch=${v.id}`);
        container.appendChild(div);
      }
    }
  } else {
    container.innerHTML = '<div style="color:#606060">é–¢é€£å‹•ç”»ãŒè¦‹ã¤ã‹ã‚‰ãªã„</div>';
  }
}

/* -------------------- ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆç„¡é™èª­ã¿è¾¼ã¿ï¼‰ -------------------- */
let commentsPageToken = {};
async function setupComments(videoId){
  const list = document.getElementById('commentsList');
  list.innerHTML = '';
  commentsPageToken[videoId] = null;
  let loading = false;

  const loadMore = async ()=>{
    if(loading) return;
    loading = true;
    try{
      const params = {part:'snippet',videoId:videoId,order:'relevance',maxResults:10};
      if(commentsPageToken[videoId]) params.pageToken = commentsPageToken[videoId];
      const res = await apiGet('commentThreads', params);
      commentsPageToken[videoId] = res.nextPageToken || null;
      for(const it of res.items || []){
        const sn = it.snippet.topLevelComment.snippet;
        const div = document.createElement('div');
        div.className = 'comment';
        div.innerHTML = `
          <img src="${sn.authorProfileImageUrl}" alt="">
          <div class="c-body">
            <div class="name">${escapeHtml(sn.authorDisplayName)} ãƒ» <span style="color:#606060;font-size:12px">${timeAgo(sn.publishedAt)}</span></div>
            <div class="text">${escapeHtml(sn.textDisplay)}</div>
          </div>
        `;
        list.appendChild(div);
      }
      if(!(res.items||[]).length && !list.innerHTML) list.innerHTML = '<div style="color:#606060">ã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ã‹ã€éè¡¨ç¤º</div>';
    }catch(e){
      console.error('comments error',e);
      list.innerHTML += `<div style="color:#c00">ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—</div>`;
    } finally {
      loading = false;
    }
  };

  // IntersectionObserver ã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const sentinel = el('commentsSentinel');
  const io = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting) loadMore();
    });
  }, {rootMargin:'400px'});
  io.observe(sentinel);
  observerMap.set('comments_'+videoId, io);
  loadMore();
}

/* -------------------- ãƒãƒ£ãƒ³ãƒãƒ«ãƒšãƒ¼ã‚¸ï¼ˆç°¡æ˜“ï¼‰ -------------------- */
async function renderChannel(channelId){
  app.innerHTML = `<div>ãƒãƒ£ãƒ³ãƒãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦</div>`;
  try{
    const data = await apiGet('channels', {part:'snippet,statistics',id:channelId});
    const ch = data.items?.[0];
    if(!ch) throw new Error('ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„');
    const title = ch.snippet.title;
    const desc = ch.snippet.description || '';
    const thumb = ch.snippet.thumbnails?.medium?.url || '';
    const subs = ch.statistics?.subscriberCount || 0;

    app.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <img src="${thumb}" style="width:88px;height:88px;border-radius:50%">
        <div>
          <div style="font-weight:700;font-size:18px">${escapeHtml(title)}</div>
          <div style="color:#606060">${fmtNum(subs)} äººã®ç™»éŒ²è€…</div>
          <div style="margin-top:8px"><button class="btn-sub">ç™»éŒ²</button></div>
        </div>
      </div>
      <div style="font-size:13px;color:#333;margin-bottom:12px">${escapeHtml(desc).slice(0,500)}${desc.length>500?'â€¦':''}</div>
      <div style="font-weight:700;margin:12px 0">å‹•ç”»</div>
      <div class="video-grid" id="channelVideos"></div>
      <div id="channelSentinel" style="height:32px"></div>
    `;

    // ãƒãƒ£ãƒ³ãƒãƒ«ã®å‹•ç”»ã‚’ search.list ã§å–å¾—
    const grid = el('channelVideos');
    let nextPage = null;
    let loading = false;
    const loadMore = async ()=>{
      if(loading) return;
      loading = true;
      try{
        const params = {part:'snippet',channelId:channelId,maxResults:MAX_RESULTS,order:'date',type:'video'};
        if(nextPage) params.pageToken = nextPage;
        const res = await apiGet('search', params);
        nextPage = res.nextPageToken || null;
        const ids = (res.items||[]).map(it=>it.id.videoId).filter(Boolean);
        if(ids.length){
          const vs = await apiGet('videos', {part:'snippet,statistics,contentDetails',id:ids.join(',')});
          for(const v of vs.items||[]){
            const card = await makeVideoCard(v);
            grid.appendChild(card);
          }
        }
      }catch(e){
        console.error('channel videos',e);
        grid.innerHTML += `<div style="color:#c00">èª­ã¿è¾¼ã¿å¤±æ•—</div>`;
      } finally {
        loading = false;
      }
    };
    const sentinel = el('channelSentinel');
    const io = new IntersectionObserver(entries=>{
      entries.forEach(ent=>{
        if(ent.isIntersecting) loadMore();
      });
    }, {rootMargin:'400px'});
    io.observe(sentinel);
    observerMap.set('channel_'+channelId, io);
    loadMore();

  }catch(e){
    app.innerHTML = `<div style="color:#c00">ãƒãƒ£ãƒ³ãƒãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${escapeHtml(e.message || String(e))}</div>`;
  }
}

/* -------------------- å°ã•ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -------------------- */
function escapeHtml(s=''){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
    </script>
  </div>

<script>
  // åˆ©ç”¨ã‚³ãƒ¼ãƒ‰åˆ¶å¾¡
  const correctPassword = "manabinotobira"; // ä»»æ„ã«å¤‰æ›´
  const input = document.getElementById('passwordInput');
  const btn = document.getElementById('passwordBtn');
  const msg = document.getElementById('passwordMsg');
  const screen = document.getElementById('passwordScreen');
  const content = document.getElementById('mainContent');

  btn.addEventListener('click', () => {
    if(input.value === correctPassword){
      screen.style.display = 'none';
      content.style.display = 'block';
    } else {
      msg.textContent = 'åˆ©ç”¨ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
      input.value = '';
      input.focus();
    }
  });

  input.addEventListener('keydown', e => {
    if(e.key === 'Enter') btn.click();
  });

  // Render ã‚’è£ã§èµ·å‹•ã—ã¦ãŠã
window.addEventListener('load', () => {
  // Render æœ¬ä½“ã‚’èµ·ã“ã™
  fetch('https://teaching-materials-r4zf.onrender.com/', { mode: 'no-cors' })
    .catch(() => {});

  // ã¤ã„ã§ã« watch.html ã‚‚èµ·ã“ã™
  fetch('https://teaching-materials-r4zf.onrender.com/watch.html?id=dummy', { mode: 'no-cors' })
    .catch(() => {});
});

</script>
</body>
</html>
